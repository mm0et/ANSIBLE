---
- name: Levantar servicios Windows y notificar solo si se levantan
  hosts: all
  gather_facts: no

  tasks:
    - name: Asegurar servicios en ejecuciÃ³n
      ansible.windows.win_service:
        name: "{{ item }}"
        state: started
      loop: "{{ services_ordered }}"
      register: servicios_resultado
      ignore_errors: true

    - name: Detectar servicios levantados por Ansible
      set_fact:
        servicios_levantados: >-
          {{ servicios_resultado.results
             | selectattr('changed','equalto',true)
             | map(attribute='item')
             | list }}

    - name: Enviar Telegram SOLO si se levantaron servicios (desde AWX controller)
      ansible.builtin.uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_id }}"
          parse_mode: Markdown
          text: |
            ðŸš¨ *AcciÃ³n automÃ¡tica de Ansible*

            ðŸ–¥ *Host:* {{ inventory_hostname }}
            ðŸ”§ *Servicios levantados:* {{ servicios_levantados | length }}
            âœ… *Estado final:* RUNNING

            ðŸ“‹ *Detalle:*
            {% for s in servicios_levantados %}
            â€¢ {{ s }}
            {% endfor %}

            â± {{ lookup('pipe','date "+%Y-%m-%d %H:%M:%S"') }}
        status_code: 200
      when: servicios_levantados | length > 0
      delegate_to: 127.0.0.1
      vars:
        ansible_connection: local
        ansible_shell_type: sh
        ansible_shell_executable: /bin/sh
